<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Universal Media Search</title>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #141414; color: white; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; text-align: center; }
        
        /* Suchbereich als Formular f√ºr Enter-Support */
        .search-box { margin-bottom: 40px; }
        form { display: flex; justify-content: center; }
        input { padding: 15px; width: 60%; border-radius: 30px 0 0 30px; border: none; font-size: 16px; background: #333; color: white; outline: none; }
        button { padding: 15px 30px; cursor: pointer; background: #e50914; color: white; border: none; border-radius: 0 30px 30px 0; font-weight: bold; }
        button:hover { background: #b20710; }

        #resultsGrid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 25px; 
            text-align: left;
        }

        .movie-card { 
            background: #1f1f1f; border-radius: 12px; overflow: hidden; 
            display: flex; flex-direction: column; border: 1px solid #333;
        }

        .poster-img { width: 100%; aspect-ratio: 2/3; object-fit: cover; background: #2a2a2a; }
        .info-padding { padding: 15px; }
        .movie-title { font-size: 1.1em; margin: 5px 0; color: #fff; }
        
        .provider-icon { width: 35px; margin-right: 5px; border-radius: 5px; margin-top: 5px; border: 1px solid #444; }
        .type-tag { font-size: 0.7em; background: #e50914; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
        
        /* Lade-Animation */
        .loader { display: none; margin: 20px auto; border: 4px solid #f3f3f3; border-top: 4px solid #e50914; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <h1>üé¨ Media Search Aggregator</h1>
        
        <div class="search-box">
            <form onsubmit="searchWithFuzzy(); return false;">
                <input type="text" id="movieInput" placeholder="Film oder Serie suchen (Enter dr√ºcken)...">
                <button type="submit">Suchen</button>
            </form>
        </div>

        <div id="loader" class="loader"></div>
        <div id="resultsGrid"></div>
    </div>

    <script>
        // IMMER GANZ OBEN: Dein Key
        const MY_API_KEY = 'e170d021dfc1298bdbbbb51399c8b4f5'; 

        async function searchWithFuzzy() {
            const query = document.getElementById('movieInput').value;
            if(!query) return;

            const grid = document.getElementById('resultsGrid');
            const loader = document.getElementById('loader');
            
            grid.innerHTML = ''; 
            loader.style.display = 'block'; // Lade-Animation zeigen

            try {
                // 1. API Abfrage
                const res = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${MY_API_KEY}&query=${encodeURIComponent(query)}&language=de-DE`);
                const data = await res.json();
                
                if (!data.results || data.results.length === 0) {
                    grid.innerHTML = "<p>Keine Ergebnisse gefunden.</p>";
                    loader.style.display = 'none';
                    return;
                }

                // 2. Fuse.js Fuzzy Logic
                const fuseOptions = {
                    keys: ['title', 'name', 'original_title'],
                    threshold: 0.4
                };
                const fuse = new Fuse(data.results, fuseOptions);
                const fuzzyResults = fuse.search(query);
                
                const finalItems = fuzzyResults.length > 0 
                    ? fuzzyResults.slice(0, 12).map(r => r.item) 
                    : data.results.slice(0, 12);

                // 3. Karten bauen
                for (let item of finalItems) {
                    if (item.media_type === 'person') continue;

                    const card = document.createElement('div');
                    card.className = 'movie-card';

                    const title = item.title || item.name;
                    const poster = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : 'https://via.placeholder.com/500x750?text=Kein+Bild';
                    
                    // Streaming-Anbieter laden
                    const pRes = await fetch(`https://api.themoviedb.org/3/${item.media_type}/${item.id}/watch/providers?api_key=${MY_API_KEY}`);
                    const pData = await pRes.json();
                    const de = pData.results?.DE?.flatrate || [];

                    let providersHtml = de.map(p => `<img src="https://image.tmdb.org/t/p/original${p.logo_path}" class="provider-icon" title="${p.provider_name}">`).join('');

                    card.innerHTML = `
                        <img src="${poster}" class="poster-img" alt="${title}">
                        <div class="info-padding">
                            <span class="type-tag">${item.media_type === 'tv' ? 'Serie' : 'Film'}</span>
                            <h3 class="movie-title">${title}</h3>
                            <div style="margin-top:10px;">
                                <small>Verf√ºgbar auf:</small><br>
                                ${providersHtml || '<span style="color:#666; font-size:0.8em;">Nur Kauf/Leihe oder nicht verf√ºgbar</span>'}
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                }
            } catch (e) {
                console.error("Fehler:", e);
                grid.innerHTML = "<p>Da ist etwas schiefgelaufen. Bitte versuche es sp√§ter erneut.</p>";
            } finally {
                loader.style.display = 'none'; // Lade-Animation verstecken
            }
        }
    </script>
</body>
</html>
